FROM nginx:alpine

ARG BUILD_VERSION
ARG http_proxy
ARG https_proxy
ARG no_proxy
ARG nvm_api_key

LABEL authors="derhecht,stevespringett,jeremylong"
LABEL maintainer="jeremy.long@gmail.com"
LABEL name="jeremylong/vulnz"
LABEL version=$BUILD_VERSION
LABEL org.label-schema.schema-version="1.0"
LABEL org.label-schema.build-date=$BUILD_DATE
LABEL org.label-schema.name="jeremylong/vulnz"
LABEL org.label-schema.description="Persist the data using the open-vulnerability-store."
LABEL org.label-schema.url="https://github.com/jeremylong/Open-Vulnerability-Project"
LABEL org.label-schema.vcs-url="https://github.com/jeremylong/Open-Vulnerability-Project"
LABEL org.label-schema.vendor="jeremylong"
LABEL org.label-schema.version=$BUILD_VERSION
LABEL org.label-schema.docker.cmd="docker run -it --rm --name mirror -e NVD_API_KEY=YOUR_API_KEY_HERE -p 80:80 jeremylong/vulnz"

ENV user=mirror
ENV BUILD_VERSION=$BUILD_VERSION
ENV JAVA_OPT=-Xmx2g
ENV NVD_API_KEY=$nvm_api_key

RUN apk update && \
    apk add --no-cache bash openjdk17 dcron nss supervisor tzdata && \
    addgroup -S "$user" && \
    adduser -S "$user" -G "$user" && \
    chown -R "$user":"$user" /usr/share/nginx/html

COPY ["/src/docker/scripts/mirror.sh", "/mirror.sh"]
COPY ["/build/libs/vulnz-$BUILD_VERSION.jar", "/usr/local/bin/vulnz"]
COPY nginx.conf /etc/nginx/conf.d/default.conf

RUN chmod +x /mirror.sh && \
    chown mirror:mirror /mirror.sh && \
    chown mirror:mirror /usr/local/bin/vulnz && /mirror.sh

EXPOSE 80/tcp
